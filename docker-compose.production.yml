version: "3"

services:
  db:
    environment:
      POSTGRES_USER: postgres
      POSTGRES_DB: changelog
    expose:
      - "5432"
    image: postgres:9.6
    logging: &logging
      driver: syslog
      options:
        syslog-address: "tcp+tls://logs7.papertrailapp.com:40471"
    volumes:
      - postgres:/var/lib/postgresql/data
  app:
    command: mix do ecto.create, ecto.migrate, phx.server
    environment:
      DB_URL: "ecto://postgres@db:5432/changelog"
      VIRTUAL_HOST: &vhost 2019.changelog.com
      HOST: *vhost
      STATIC_HOST: *vhost
      CM_API_TOKEN: /run/secrets/campaign_monitor_api_token
      GITHUB_API_TOKEN: /run/secrets/github_api_token
      GITHUB_CLIENT_ID: /run/secrets/github_client_id
      GITHUB_CLIENT_SECRET: /run/secrets/github_client_secret
      AWS_ACCESS_KEY_ID: /run/secrets/aws_access_key_id
      AWS_SECRET_ACCESS_KEY: /run/secrets/aws_secret_access_key
      TWITTER_CONSUMER_KEY: /run/secrets/twitter_consumer_key
      TWITTER_CONSUMER_SECRET: /run/secrets/twitter_consumer_secret
      SECRET_KEY_BASE: /run/secrets/secret_key_base
      SIGNING_SALT: /run/secrets/signing_salt
      SLACK_INVITE_API_TOKEN: /run/secrets/slack_invite_api_token
      SLACK_APP_API_TOKEN: /run/secrets/slack_app_api_token
      ROLLBAR_ACCESS_TOKEN: /run/secrets/rollbar_access_token
      BUFFER_TOKEN: /run/secrets/buffer_token
      COVERALLS_REPO_TOKEN: /run/secrets/coveralls_repo_token
      ALGOLIA_APPLICATION_ID: /run/secrets/algolia_application_id
      ALGOLIA_API_KEY: /run/secrets/algolia_api_key
    depends_on:
      - db
    image: thechangelog.com/changelog.com
    logging: *logging
    secrets:
      - campaign_monitor_api_token
      - github_api_token
      - github_client_id
      - github_client_secret
      - aws_access_key_id
      - aws_secret_access_key
      - twitter_consumer_key
      - twitter_consumer_secret
      - secret_key_base
      - signing_salt
      - slack_app_api_token
      - rollbar_access_token
      - buffer_token
      - coveralls_repo_token
      - algolia_application_id
      - algolia_api_key
    volumes:
      - uploads:./priv/uploads
  proxy:
    image: thechangelog/proxy
    logging: *logging
    ports:
      - "80:80"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./nginx/vhost.d:/etc/nginx/vhost.d:ro
      - ./nginx/conf.d/changelog.conf:/etc/nginx/conf.d/changelog.conf:ro
      - uploads:/var/www/uploads:ro

volumes:
  postgres:
  uploads:
